
<!doctype html>
<html class="no-js" lang="zxx">
<head>
<!-- Meta Tags -->
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="keywords" content="Site keywords here">
<meta name="description" content="">
<meta name='copyright' content=''>
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<!-- Title -->
<title>Dashboard - JOEeXPRESS</title>
<!-- Favicon -->
<link href="https://fonts.googleapis.com/css?family=Poppins:200i,300,300i,400,400i,500,500i,600,600i,700,700i,800,800i,900,900i&display=swap" rel="stylesheet">

<!-- Bootstrap CSS -->
<link rel="stylesheet" href="css/bootstrap.min.css">
<link rel="stylesheet" href="css/nice-select.css">
<link rel="stylesheet" href="css/font-awesome.min.css">
<link rel="stylesheet" href="css/icofont.css">
<link rel="stylesheet" href="css/slicknav.min.css">
<link rel="stylesheet" href="css/owl-carousel.css">
<link rel="stylesheet" href="css/datepicker.css">
<link rel="stylesheet" href="css/animate.min.css">
<link rel="stylesheet" href="css/magnific-popup.css">
<link rel="stylesheet" href="css/normalize.css">
<link rel="stylesheet" href="style.css">
<link rel="stylesheet" href="css/responsive.css">

<!-- Supabase -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
.dashboard-container {

min-height: 100vh;
padding: 20px 0;
position: relative;
overflow-x: hidden;
}

.dashboard-container::before {
content: '';
position: absolute;
top: 0;
left: 0;
right: 0;
bottom: 0;
background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.05)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
opacity: 0.3;
pointer-events: none;
}

.dashboard-header {
background: rgba(255, 255, 255, 0.98);
backdrop-filter: blur(20px);
padding: 30px;
border-radius: 20px;
margin-bottom: 30px;
box-shadow: 0 20px 60px rgba(0,0,0,0.15);
border: 1px solid rgba(255,255,255,0.2);
position: relative;
z-index: 1;
}

.user-info {
display: flex;
align-items: center;
gap: 20px;
}

.user-avatar {
width: 80px;
height: 80px;
border-radius: 50%;
object-fit: cover;
border: 4px solid #007bff;
}

.user-details h2 {
margin: 0;
color: #333;
}

.user-role {
background: #007bff;
color: white;
padding: 5px 15px;
border-radius: 20px;
font-size: 12px;
text-transform: uppercase;
font-weight: 600;
}

.xp-badge {
background: linear-gradient(45deg, #ffd700, #ffed4e);
color: #333;
padding: 8px 16px;
border-radius: 25px;
font-weight: bold;
font-size: 14px;
}

.dashboard-grid {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
gap: 20px;
margin-bottom: 30px;
}

.dashboard-card {
background: rgba(255, 255, 255, 0.98);
backdrop-filter: blur(20px);
border-radius: 20px;
padding: 30px;
box-shadow: 0 20px 60px rgba(0,0,0,0.15);
border: 1px solid rgba(255,255,255,0.2);
transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
position: relative;
overflow: hidden;
z-index: 1;
}

.dashboard-card::before {
content: '';
position: absolute;
top: 0;
left: 0;
right: 0;
height: 4px;
background: linear-gradient(90deg, #1a76d1, #2563eb, #3b82f6);
border-radius: 20px 20px 0 0;
}

.dashboard-card:hover {
transform: translateY(-8px) scale(1.02);
box-shadow: 0 30px 80px rgba(0,0,0,0.2);
}

.card-header {
display: flex;
align-items: center;
justify-content: between;
margin-bottom: 20px;
}

.card-title {
font-size: 18px;
font-weight: 600;
color: #333;
margin: 0;
}

.card-icon {
font-size: 24px;
margin-right: 10px;
}

.progress-bar {
background: #e1e5e9;
border-radius: 10px;
height: 8px;
overflow: hidden;
margin: 10px 0;
}

.progress-fill {
background: linear-gradient(45deg, #007bff, #0056b3);
height: 100%;
border-radius: 10px;
transition: width 0.3s ease;
}

.course-item {
background: #f8f9fa;
padding: 15px;
border-radius: 10px;
margin-bottom: 10px;
cursor: pointer;
transition: background 0.3s ease;
}

.course-item:hover {
background: #e9ecef;
}

.badge-item {
display: inline-block;
background: linear-gradient(45deg, #ffd700, #ffed4e);
color: #333;
padding: 8px 12px;
border-radius: 20px;
margin: 5px;
font-size: 12px;
font-weight: 600;
}

.badge-item.earned {
background: linear-gradient(45deg, #28a745, #20c997);
color: white;
}

.event-item {
border-left: 4px solid #007bff;
padding: 15px;
margin-bottom: 15px;
background: #f8f9fa;
border-radius: 0 10px 10px 0;
}

.notification-item {
padding: 12px;
border-bottom: 1px solid #eee;
cursor: pointer;
transition: background 0.3s ease;
}

.notification-item:hover {
background: #f8f9fa;
}

.notification-item.unread {
background: #e3f2fd;
font-weight: 600;
}

.forum-post {
background: #f8f9fa;
padding: 15px;
border-radius: 10px;
margin-bottom: 15px;
border-left: 4px solid #007bff;
}

.stats-grid {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
gap: 15px;
}

.stat-item {
text-align: center;
padding: 20px;
background: linear-gradient(45deg, #007bff, #0056b3);
color: white;
border-radius: 15px;
}

.stat-number {
font-size: 2em;
font-weight: bold;
display: block;
}

.btn-primary {
background: linear-gradient(45deg, #007bff, #0056b3);
border: none;
padding: 10px 20px;
border-radius: 8px;
color: white;
cursor: pointer;
transition: transform 0.2s ease;
}

.btn-primary:hover {
transform: translateY(-2px);
}

.btn-success {
background: linear-gradient(45deg, #28a745, #20c997);
border: none;
padding: 8px 16px;
border-radius: 6px;
color: white;
cursor: pointer;
font-size: 12px;
}

.admin-panel {
background: linear-gradient(45deg, #dc3545, #c82333);
color: white;
}

.admin-controls {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
gap: 15px;
margin-top: 20px;
}

.admin-btn {
background: rgba(255, 255, 255, 0.2);
border: 2px solid rgba(255, 255, 255, 0.3);
color: white;
padding: 15px;
border-radius: 10px;
cursor: pointer;
text-align: center;
transition: background 0.3s ease;
}

.admin-btn:hover {
background: rgba(255, 255, 255, 0.3);
}

.modal {
display: none;
position: fixed;
z-index: 1000;
left: 0;
top: 0;
width: 100%;
height: 100%;
background-color: rgba(0,0,0,0.5);
}

.modal-content {
background-color: #fefefe;
margin: 5% auto;
padding: 20px;
border-radius: 15px;
width: 90%;
max-width: 500px;
max-height: 80vh;
overflow-y: auto;
}

.close {
color: #aaa;
float: right;
font-size: 28px;
font-weight: bold;
cursor: pointer;
}

.close:hover {
color: #000;
}

.form-group {
margin-bottom: 15px;
}

.form-control {
width: 100%;
padding: 10px;
border: 2px solid #e1e5e9;
border-radius: 8px;
font-size: 14px;
}

.loading {
text-align: center;
padding: 20px;
color: #666;
}

.leaderboard-item {
display: flex;
align-items: center;
justify-content: space-between;
padding: 10px;
border-bottom: 1px solid #eee;
}

.rank {
font-weight: bold;
font-size: 18px;
color: #007bff;
margin-right: 15px;
}

.user-name {
flex-grow: 1;
}

.user-xp {
color: #ffd700;
font-weight: bold;
}

.hidden {
display: none !important;
}

/* Enhanced animations */
@keyframes pulse {
0%, 100% { transform: scale(1); }
50% { transform: scale(1.05); }
}

@keyframes fadeInUp {
from {
opacity: 0;
transform: translateY(30px);
}
to {
opacity: 1;
transform: translateY(0);
}
}

.animate-fade-in {
animation: fadeInUp 0.6s ease-out forwards;
}

/* Enhanced glassmorphism effect */
.dashboard-card:hover::before {
opacity: 0.8;
}

/* Responsive grid improvements */
@media (max-width: 768px) {
.dashboard-grid {
grid-template-columns: 1fr;
gap: 15px;
}

.dashboard-header {
padding: 20px;
}

.user-info {
flex-direction: column;
text-align: center;
gap: 15px;
}

.stats-grid {
grid-template-columns: repeat(2, 1fr);
}
}
</style>
</head>
<body>

<!-- Header Area -->
<header class="header">
<div class="header-inner">
<div class="container">
<div class="inner">
<div class="row">
<div class="col-lg-3 col-md-3 col-12">
<div class="logo">
<a href="index.html"><img src="images/updatedLogo.jpg" max-width="50%" height="100px" alt="je-tech-hub logo"></a>
</div>
<div class="mobile-nav"></div>
</div>
<div class="col-lg-7 col-md-9 col-12">
<div class="main-menu">
<nav class="navigation">
<ul class="nav menu">
<li><a href="index.html">Home</a></li>
<li><a href="aboutUS.html">About Us</a></li>
<li><a href="programs.html">Programs</a></li>
<li><a href="contactUs.html">Contact Us</a></li>
<li><a href="#" onclick="signOut()" style="color: #dc3545;">Sign Out</a></li>
</ul>
</nav>
</div>
</div>
</div>
</div>
</div>
</div>
</header>

<div class="dashboard-container">
<div class="container">
<!-- Dashboard Header with User Info -->
<div class="dashboard-header">
<div class="user-info">
<img id="userAvatar" src="https://via.placeholder.com/80x80?text=User" alt="User Avatar" class="user-avatar">
<div class="user-details">
<h2 id="userName">Loading...</h2>
<div style="display: flex; gap: 15px; align-items: center; margin-top: 10px;">
<span id="userRole" class="user-role">Loading...</span>
<span id="userXP" class="xp-badge">0 XP</span>
</div>
</div>
<button class="btn-primary" onclick="openProfileModal()">Edit Profile</button>
</div>
</div>

<!-- Dashboard Grid -->
<div class="dashboard-grid">
<!-- Learning Statistics -->
<div class="dashboard-card">
<div class="card-header">
<h3 class="card-title"><span class="card-icon">üìä</span> Learning Stats</h3>
</div>
<div class="stats-grid">
<div class="stat-item">
<span id="totalCourses" class="stat-number">0</span>
<small>Courses Completed</small>
</div>
<div class="stat-item">
<span id="totalHours" class="stat-number">0</span>
<small>Hours Studied</small>
</div>
<div class="stat-item">
<span id="totalXP" class="stat-number">0</span>
<small>Total XP</small>
</div>
</div>
</div>

<!-- Continue Learning -->
<div id="learningSection" class="dashboard-card">
<div class="card-header">
<h3 class="card-title"><span class="card-icon">üìö</span> Continue Learning</h3>
<button class="btn-primary" onclick="openEnrollModal()">Enroll in Course</button>
</div>
<div id="enrolledCourses">
<div class="loading">Loading your courses...</div>
</div>
</div>

<!-- Achievements & Badges -->
<div class="dashboard-card">
<div class="card-header">
<h3 class="card-title"><span class="card-icon">üèÜ</span> Achievements</h3>
</div>
<div id="badgesContainer">
<div class="loading">Loading achievements...</div>
</div>
</div>

<!-- Upcoming Events -->
<div class="dashboard-card">
<div class="card-header">
<h3 class="card-title"><span class="card-icon">üìÖ</span> Upcoming Events</h3>
</div>
<div id="eventsContainer">
<div class="loading">Loading events...</div>
</div>
</div>

<!-- Notifications -->
<div class="dashboard-card">
<div class="card-header">
<h3 class="card-title"><span class="card-icon">üîî</span> Notifications</h3>
</div>
<div id="notificationsContainer" style="max-height: 300px; overflow-y: auto;">
<div class="loading">Loading notifications...</div>
</div>
</div>

<!-- Community Forum -->
<div class="dashboard-card">
<div class="card-header">
<h3 class="card-title"><span class="card-icon">üí¨</span> Community Forum</h3>
<button class="btn-primary" onclick="openPostModal()">New Post</button>
</div>
<div id="forumContainer" style="max-height: 400px; overflow-y: auto;">
<div class="loading">Loading forum posts...</div>
</div>
</div>

<!-- Leaderboard -->
<div class="dashboard-card">
<div class="card-header">
<h3 class="card-title"><span class="card-icon">ü•á</span> Leaderboard</h3>
</div>
<div id="leaderboardContainer">
<div class="loading">Loading leaderboard...</div>
</div>
</div>

<!-- Admin Panel (Only for Admins) -->
<div id="adminPanel" class="dashboard-card admin-panel hidden">
<div class="card-header">
<h3 class="card-title"><span class="card-icon">‚öôÔ∏è</span> Admin Panel</h3>
</div>
<div class="admin-controls">
<div class="admin-btn" onclick="openUserManagementModal()">
üë• Manage Users
</div>
<div class="admin-btn" onclick="openEventModal()">
üìÖ Create Event
</div>
<div class="admin-btn" onclick="openAnnouncementModal()">
üì¢ Send Announcement
</div>
<div class="admin-btn" onclick="viewAnalytics()">
üìà View Analytics
</div>
</div>
</div>
</div>
</div>
</div>

<!-- Modals -->
<!-- Profile Edit Modal -->
<div id="profileModal" class="modal">
<div class="modal-content">
<span class="close" onclick="closeModal('profileModal')">&times;</span>
<h2>Edit Profile</h2>
<form id="profileForm">
<div class="form-group">
<label>First Name:</label>
<input type="text" id="editFirstName" class="form-control" required>
</div>
<div class="form-group">
<label>Last Name:</label>
<input type="text" id="editLastName" class="form-control" required>
</div>
<div class="form-group">
<label>Phone:</label>
<input type="tel" id="editPhone" class="form-control">
</div>
<div class="form-group">
<label>Bio:</label>
<textarea id="editBio" class="form-control" rows="3"></textarea>
</div>
<div class="form-group">
<label>Avatar URL:</label>
<input type="url" id="editAvatarUrl" class="form-control">
</div>
<button type="submit" class="btn-primary">Update Profile</button>
</form>
</div>
</div>

<!-- Course Enrollment Modal -->
<div id="enrollModal" class="modal">
<div class="modal-content">
<span class="close" onclick="closeModal('enrollModal')">&times;</span>
<h2>Enroll in Course</h2>
<div id="availableCourses">
<div class="loading">Loading available courses...</div>
</div>
</div>
</div>

<!-- New Post Modal -->
<div id="postModal" class="modal">
<div class="modal-content">
<span class="close" onclick="closeModal('postModal')">&times;</span>
<h2>Create New Post</h2>
<form id="postForm">
<div class="form-group">
<label>Title:</label>
<input type="text" id="postTitle" class="form-control" required>
</div>
<div class="form-group">
<label>Content:</label>
<textarea id="postContent" class="form-control" rows="5" required></textarea>
</div>
<button type="submit" class="btn-primary">Create Post</button>
</form>
</div>
</div>

<!-- Event Modal -->
<div id="eventModal" class="modal">
<div class="modal-content">
<span class="close" onclick="closeModal('eventModal')">&times;</span>
<h2>Create New Event</h2>
<form id="eventForm">
<div class="form-group">
<label>Title:</label>
<input type="text" id="eventTitle" class="form-control" required>
</div>
<div class="form-group">
<label>Description:</label>
<textarea id="eventDescription" class="form-control" rows="3"></textarea>
</div>
<div class="form-group">
<label>Date & Time:</label>
<input type="datetime-local" id="eventDate" class="form-control" required>
</div>
<div class="form-group">
<label>Location:</label>
<input type="text" id="eventLocation" class="form-control">
</div>
<div class="form-group">
<label>Max Attendees:</label>
<input type="number" id="eventMaxAttendees" class="form-control" min="1">
</div>
<button type="submit" class="btn-primary">Create Event</button>
</form>
</div>
</div>

<!-- User Management Modal -->
<div id="userManagementModal" class="modal">
<div class="modal-content">
<span class="close" onclick="closeModal('userManagementModal')">&times;</span>
<h2>User Management</h2>
<div id="usersList">
<div class="loading">Loading users...</div>
</div>
</div>
</div>

<!-- Announcement Modal -->
<div id="announcementModal" class="modal">
<div class="modal-content">
<span class="close" onclick="closeModal('announcementModal')">&times;</span>
<h2>Send Announcement</h2>
<form id="announcementForm">
<div class="form-group">
<label>Title:</label>
<input type="text" id="announcementTitle" class="form-control" required>
</div>
<div class="form-group">
<label>Message:</label>
<textarea id="announcementMessage" class="form-control" rows="4" required></textarea>
</div>
<div class="form-group">
<label>Send to:</label>
<select id="announcementTarget" class="form-control">
<option value="all">All Users</option>
<option value="student">Students Only</option>
<option value="non-student">Non-Students Only</option>
</select>
</div>
<button type="submit" class="btn-primary">Send Announcement</button>
</form>
</div>
</div>

<script>
// Initialize Supabase client
const supabaseUrl = 'https://icqzgoagqosthgipepdq.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImljcXpnb2FncW9zdGhnaXBlcGRxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkwODI1NzAsImV4cCI6MjA2NDY1ODU3MH0.nzLqXrmUOmplR71fW-fumg58DiUOs_cKDqmjeuT8Yrg';
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

// Global variables
let currentUser = null;
let userProfile = null;

// Initialize dashboard when page loads
document.addEventListener('DOMContentLoaded', async function() {
console.log('Dashboard initializing...');

// Check if user is authenticated
const { data: { session } } = await supabase.auth.getSession();

if (!session) {
console.log('No session found, redirecting to login');
window.location.href = 'getStarted.html';
return;
}

currentUser = session.user;
console.log('User authenticated:', currentUser.id);

// Load user profile and initialize dashboard
await loadUserProfile();
await initializeDashboard();
});

/**
* Load user profile from database
*/
async function loadUserProfile() {
try {
console.log('Loading user profile...');

const { data, error } = await supabase
.from('profiles')
.select('*')
.eq('id', currentUser.id)
.single();

if (error) {
console.error('Error loading profile:', error);
return;
}

userProfile = data;
console.log('Profile loaded:', userProfile);

// Update UI with user info
updateUserInfo();

} catch (error) {
console.error('Error in loadUserProfile:', error);
}
}

/**
* Update user info display in header
*/
function updateUserInfo() {
if (!userProfile) return;

// Update user name
document.getElementById('userName').textContent = 
userProfile.full_name || `${userProfile.first_name || ''} ${userProfile.last_name || ''}`.trim() || 'User';

// Update user role
const roleElement = document.getElementById('userRole');
roleElement.textContent = userProfile.role || 'non-student';
roleElement.className = `user-role ${userProfile.role}`;

// Update XP display
document.getElementById('userXP').textContent = `${userProfile.xp || 0} XP`;

// Update avatar
if (userProfile.avatar_url) {
document.getElementById('userAvatar').src = userProfile.avatar_url;
}

// Show admin panel if user is admin
if (userProfile.role === 'admin') {
document.getElementById('adminPanel').classList.remove('hidden');
}

console.log('User info updated');
}

/**
* Initialize all dashboard sections
*/
async function initializeDashboard() {
console.log('Initializing dashboard sections...');

// Load all dashboard data concurrently
await Promise.all([
loadLearningStats(),
loadEnrolledCourses(),
loadBadges(),
loadUpcomingEvents(),
loadNotifications(),
loadForumPosts(),
loadLeaderboard()
]);

// Add enhanced animations after content loads
addEnhancedAnimations();
animateProgressBars();

console.log('Dashboard initialization complete');

// Enhanced animations and interactions
function addEnhancedAnimations() {
// Add smooth loading animation for cards
const cards = document.querySelectorAll('.dashboard-card');
cards.forEach((card, index) => {
card.style.opacity = '0';
card.style.transform = 'translateY(30px)';
setTimeout(() => {
card.style.transition = 'all 0.6s cubic-bezier(0.4, 0, 0.2, 1)';
card.style.opacity = '1';
card.style.transform = 'translateY(0)';
}, index * 100);
});

// Add pulse animation to notification badges
const badges = document.querySelectorAll('.notification-badge');
badges.forEach(badge => {
if (parseInt(badge.textContent) > 0) {
badge.style.animation = 'pulse 2s infinite';
}
});

// Add smooth scroll behavior
document.documentElement.style.scrollBehavior = 'smooth';
}

// Enhanced progress bar animation
function animateProgressBars() {
const progressBars = document.querySelectorAll('.progress-fill');
progressBars.forEach(bar => {
const width = bar.style.width;
bar.style.width = '0%';
setTimeout(() => {
bar.style.transition = 'width 1.5s cubic-bezier(0.4, 0, 0.2, 1)';
bar.style.width = width;
}, 500);
});
}
}

/**
* Load and display learning statistics
*/
async function loadLearningStats() {
try {
console.log('Loading learning stats...');

// Update stats display
document.getElementById('totalCourses').textContent = userProfile.courses_completed || 0;
document.getElementById('totalHours').textContent = userProfile.total_hours_studied || 0;
document.getElementById('totalXP').textContent = userProfile.xp || 0;

} catch (error) {
console.error('Error loading learning stats:', error);
}
}

/**
* Load and display enrolled courses
*/
async function loadEnrolledCourses() {
try {
console.log('Loading enrolled courses...');

const { data: enrollments, error } = await supabase
.from('enrollments')
.select(`
*,
courses (*)
`)
.eq('user_id', currentUser.id);

if (error) {
console.error('Error loading enrollments:', error);
return;
}

const container = document.getElementById('enrolledCourses');

if (!enrollments || enrollments.length === 0) {
container.innerHTML = '<p>No enrolled courses yet. Enroll in a course to start learning!</p>';
return;
}

// Generate HTML for enrolled courses
container.innerHTML = enrollments.map(enrollment => `
<div class="course-item" onclick="continueCourse('${enrollment.course_id}', ${enrollment.last_lesson_completed})">
<h4>${enrollment.courses.title}</h4>
<p>${enrollment.courses.description}</p>
<div class="progress-bar">
<div class="progress-fill" style="width: ${enrollment.progress_percentage}%"></div>
</div>
<small>Progress: ${enrollment.progress_percentage}% ‚Ä¢ Last lesson: ${enrollment.last_lesson_completed}</small>
</div>
`).join('');

console.log('Enrolled courses loaded');

} catch (error) {
console.error('Error in loadEnrolledCourses:', error);
}
}

/**
* Load and display user badges
*/
async function loadBadges() {
try {
console.log('Loading badges...');

// Get all available badges
const { data: allBadges, error: badgesError } = await supabase
.from('badges')
.select('*')
.order('xp_required', { ascending: true });

if (badgesError) {
console.error('Error loading badges:', badgesError);
return;
}

// Get user's earned badges
const { data: userBadges, error: userBadgesError } = await supabase
.from('user_badges')
.select('badge_id')
.eq('user_id', currentUser.id);

if (userBadgesError) {
console.error('Error loading user badges:', userBadgesError);
return;
}

const earnedBadgeIds = userBadges.map(ub => ub.badge_id);

const container = document.getElementById('badgesContainer');
container.innerHTML = allBadges.map(badge => {
const isEarned = earnedBadgeIds.includes(badge.id);
const userXP = userProfile.xp || 0;
const canEarn = userXP >= badge.xp_required && !isEarned;

return `
<div class="badge-item ${isEarned ? 'earned' : ''}" 
onclick="${canEarn ? `earnBadge('${badge.id}')` : ''}">
${badge.icon} ${badge.name}
<br><small>${badge.description}</small>
<br><small>${badge.xp_required} XP required</small>
${canEarn ? '<br><small style="color: green;">Click to earn!</small>' : ''}
</div>
`;
}).join('');

console.log('Badges loaded');

} catch (error) {
console.error('Error in loadBadges:', error);
}
}

/**
* Load and display upcoming events
*/
async function loadUpcomingEvents() {
try {
console.log('Loading upcoming events...');

const { data: events, error } = await supabase
.from('events')
.select('*')
.gte('event_date', new Date().toISOString())
.order('event_date', { ascending: true })
.limit(5);

if (error) {
console.error('Error loading events:', error);
return;
}

const container = document.getElementById('eventsContainer');

if (!events || events.length === 0) {
container.innerHTML = '<p>No upcoming events.</p>';
return;
}

// Get user's RSVPs
const { data: rsvps } = await supabase
.from('event_rsvps')
.select('event_id, rsvp_status')
.eq('user_id', currentUser.id);

const userRSVPs = {};
rsvps?.forEach(rsvp => {
userRSVPs[rsvp.event_id] = rsvp.rsvp_status;
});

container.innerHTML = events.map(event => {
const eventDate = new Date(event.event_date);
const userRSVP = userRSVPs[event.id];

return `
<div class="event-item">
<h4>${event.title}</h4>
<p>${event.description}</p>
<small>üìÖ ${eventDate.toLocaleDateString()} at ${eventDate.toLocaleTimeString()}</small>
<br><small>üìç ${event.location || 'Online'}</small>
<br><small>üë• ${event.current_attendees}/${event.max_attendees || '‚àû'} attendees</small>
<br>
<button class="btn-success" onclick="rsvpEvent('${event.id}', 'attending')">
${userRSVP === 'attending' ? '‚úì Attending' : 'RSVP'}
</button>
</div>
`;
}).join('');

console.log('Events loaded');

} catch (error) {
console.error('Error in loadUpcomingEvents:', error);
}
}

/**
* Load and display notifications
*/
async function loadNotifications() {
try {
console.log('Loading notifications...');

const { data: notifications, error } = await supabase
.from('notifications')
.select('*')
.eq('user_id', currentUser.id)
.order('created_at', { ascending: false })
.limit(10);

if (error) {
console.error('Error loading notifications:', error);
return;
}

const container = document.getElementById('notificationsContainer');

if (!notifications || notifications.length === 0) {
container.innerHTML = '<p>No notifications.</p>';
return;
}

container.innerHTML = notifications.map(notification => `
<div class="notification-item ${!notification.is_read ? 'unread' : ''}" 
onclick="markNotificationRead('${notification.id}')">
<strong>${notification.title}</strong>
<p>${notification.message}</p>
<small>${new Date(notification.created_at).toLocaleDateString()}</small>
</div>
`).join('');

console.log('Notifications loaded');

} catch (error) {
console.error('Error in loadNotifications:', error);
}
}

/**
* Load and display forum posts
*/
async function loadForumPosts() {
try {
console.log('Loading forum posts...');

const { data: posts, error } = await supabase
.from('forum_posts')
.select(`
*,
profiles (first_name, last_name, full_name)
`)
.order('created_at', { ascending: false })
.limit(5);

if (error) {
console.error('Error loading forum posts:', error);
return;
}

const container = document.getElementById('forumContainer');

if (!posts || posts.length === 0) {
container.innerHTML = '<p>No forum posts yet. Be the first to start a discussion!</p>';
return;
}

container.innerHTML = posts.map(post => {
const authorName = post.profiles.full_name || 
`${post.profiles.first_name || ''} ${post.profiles.last_name || ''}`.trim() || 
'Anonymous';

return `
<div class="forum-post">
<h4>${post.title}</h4>
<p>${post.content}</p>
<small>By ${authorName} ‚Ä¢ ${new Date(post.created_at).toLocaleDateString()} ‚Ä¢ 
üëç ${post.likes_count} likes ‚Ä¢ üí¨ ${post.replies_count} replies</small>
</div>
`;
}).join('');

console.log('Forum posts loaded');

} catch (error) {
console.error('Error in loadForumPosts:', error);
}
}

/**
* Load and display leaderboard
*/
async function loadLeaderboard() {
try {
console.log('Loading leaderboard...');

const { data: topUsers, error } = await supabase
.from('profiles')
.select('first_name, last_name, full_name, xp')
.order('xp', { ascending: false })
.limit(10);

if (error) {
console.error('Error loading leaderboard:', error);
return;
}

const container = document.getElementById('leaderboardContainer');

if (!topUsers || topUsers.length === 0) {
container.innerHTML = '<p>No data available.</p>';
return;
}

container.innerHTML = topUsers.map((user, index) => {
const userName = user.full_name || 
`${user.first_name || ''} ${user.last_name || ''}`.trim() || 
'Anonymous';

return `
<div class="leaderboard-item">
<span class="rank">#${index + 1}</span>
<span class="user-name">${userName}</span>
<span class="user-xp">${user.xp || 0} XP</span>
</div>
`;
}).join('');

console.log('Leaderboard loaded');

} catch (error) {
console.error('Error in loadLeaderboard:', error);
}
}

/**
* Continue learning from a specific course and lesson
*/
function continueCourse(courseId, lastLesson) {
console.log(`Continuing course ${courseId} from lesson ${lastLesson + 1}`);
// This would redirect to the actual learning interface
alert(`Continuing course from lesson ${lastLesson + 1}. This would redirect to the learning platform.`);
}

/**
* Award a badge to the user
*/
async function earnBadge(badgeId) {
try {
console.log('Earning badge:', badgeId);

const { error } = await supabase
.from('user_badges')
.insert([
{ user_id: currentUser.id, badge_id: badgeId }
]);

if (error) {
console.error('Error earning badge:', error);
return;
}

alert('Congratulations! Badge earned! üéâ');
await loadBadges(); // Reload badges

} catch (error) {
console.error('Error in earnBadge:', error);
}
}

/**
* RSVP for an event
*/
async function rsvpEvent(eventId, status) {
try {
console.log('RSVP for event:', eventId, status);

const { error } = await supabase
.from('event_rsvps')
.upsert([
{ 
user_id: currentUser.id, 
event_id: eventId, 
rsvp_status: status 
}
]);

if (error) {
console.error('Error with RSVP:', error);
return;
}

alert('RSVP confirmed! üéâ');
await loadUpcomingEvents(); // Reload events

} catch (error) {
console.error('Error in rsvpEvent:', error);
}
}

/**
* Mark notification as read
*/
async function markNotificationRead(notificationId) {
try {
console.log('Marking notification as read:', notificationId);

const { error } = await supabase
.from('notifications')
.update({ is_read: true })
.eq('id', notificationId);

if (error) {
console.error('Error marking notification as read:', error);
return;
}

await loadNotifications(); // Reload notifications

} catch (error) {
console.error('Error in markNotificationRead:', error);
}
}

/**
* Open profile edit modal
*/
function openProfileModal() {
if (!userProfile) return;

// Populate form with current data
document.getElementById('editFirstName').value = userProfile.first_name || '';
document.getElementById('editLastName').value = userProfile.last_name || '';
document.getElementById('editPhone').value = userProfile.phone || '';
document.getElementById('editBio').value = userProfile.bio || '';
document.getElementById('editAvatarUrl').value = userProfile.avatar_url || '';

document.getElementById('profileModal').style.display = 'block';
}

/**
* Open course enrollment modal
*/
async function openEnrollModal() {
try {
// Load available courses
const { data: courses, error } = await supabase
.from('courses')
.select('*');

if (error) {
console.error('Error loading courses:', error);
return;
}

// Get user's enrolled courses to filter them out
const { data: enrollments } = await supabase
.from('enrollments')
.select('course_id')
.eq('user_id', currentUser.id);

const enrolledCourseIds = enrollments?.map(e => e.course_id) || [];
const availableCourses = courses.filter(course => !enrolledCourseIds.includes(course.id));

const container = document.getElementById('availableCourses');

if (availableCourses.length === 0) {
container.innerHTML = '<p>No new courses available for enrollment.</p>';
} else {
container.innerHTML = availableCourses.map(course => `
<div class="course-item" onclick="enrollInCourse('${course.id}')">
<h4>${course.title}</h4>
<p>${course.description}</p>
<small>Duration: ${course.duration_hours} hours ‚Ä¢ Level: ${course.difficulty_level}</small>
<br><small>Instructor: ${course.instructor_name}</small>
</div>
`).join('');
}

document.getElementById('enrollModal').style.display = 'block';

} catch (error) {
console.error('Error in openEnrollModal:', error);
}
}

/**
* Enroll user in a course
*/
async function enrollInCourse(courseId) {
try {
console.log('Enrolling in course:', courseId);

const { error } = await supabase
.from('enrollments')
.insert([
{ 
user_id: currentUser.id, 
course_id: courseId,
progress_percentage: 0,
last_lesson_completed: 0
}
]);

if (error) {
console.error('Error enrolling in course:', error);
return;
}

alert('Successfully enrolled in course! üéâ');
closeModal('enrollModal');
await loadEnrolledCourses(); // Reload enrolled courses

} catch (error) {
console.error('Error in enrollInCourse:', error);
}
}

/**
* Open new post modal
*/
function openPostModal() {
document.getElementById('postModal').style.display = 'block';
}

/**
* Open event creation modal (admin only)
*/
function openEventModal() {
document.getElementById('eventModal').style.display = 'block';
}

/**
* Open user management modal (admin only)
*/
async function openUserManagementModal() {
try {
const { data: users, error } = await supabase
.from('profiles')
.select('*')
.order('created_at', { ascending: false });

if (error) {
console.error('Error loading users:', error);
return;
}

const container = document.getElementById('usersList');
container.innerHTML = users.map(user => {
const userName = user.full_name || `${user.first_name || ''} ${user.last_name || ''}`.trim() || 'Anonymous';

return `
<div style="padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
<div>
<strong>${userName}</strong><br>
<small>${user.email} ‚Ä¢ Role: ${user.role} ‚Ä¢ XP: ${user.xp || 0}</small>
</div>
<div>
<button class="btn-primary" onclick="changeUserRole('${user.id}', '${user.role}')">Change Role</button>
</div>
</div>
`;
}).join('');

document.getElementById('userManagementModal').style.display = 'block';

} catch (error) {
console.error('Error in openUserManagementModal:', error);
}
}

/**
* Open announcement modal (admin only)
*/
function openAnnouncementModal() {
document.getElementById('announcementModal').style.display = 'block';
}

/**
* Change user role (admin only)
*/
async function changeUserRole(userId, currentRole) {
const roles = ['non-student', 'student', 'admin'];
const currentIndex = roles.indexOf(currentRole);
const newRole = roles[(currentIndex + 1) % roles.length];

try {
const { error } = await supabase
.from('profiles')
.update({ role: newRole })
.eq('id', userId);

if (error) {
console.error('Error changing user role:', error);
return;
}

alert(`User role changed to ${newRole}`);
await openUserManagementModal(); // Reload users list

} catch (error) {
console.error('Error in changeUserRole:', error);
}
}

/**
* View analytics (admin only)
*/
function viewAnalytics() {
alert('Analytics dashboard would open here. This would show site-wide statistics, user engagement metrics, course completion rates, etc.');
}

/**
* Close modal
*/
function closeModal(modalId) {
document.getElementById(modalId).style.display = 'none';
}

/**
* Sign out user
*/
async function signOut() {
try {
const { error } = await supabase.auth.signOut();
if (error) {
console.error('Error signing out:', error);
return;
}

window.location.href = 'getStarted.html';

} catch (error) {
console.error('Error in signOut:', error);
}
}

// Form event listeners
document.addEventListener('DOMContentLoaded', function() {
// Profile form submission
document.getElementById('profileForm').addEventListener('submit', async function(e) {
e.preventDefault();

try {
const { error } = await supabase
.from('profiles')
.update({
first_name: document.getElementById('editFirstName').value,
last_name: document.getElementById('editLastName').value,
phone: document.getElementById('editPhone').value,
bio: document.getElementById('editBio').value,
avatar_url: document.getElementById('editAvatarUrl').value,
full_name: `${document.getElementById('editFirstName').value} ${document.getElementById('editLastName').value}`.trim()
})
.eq('id', currentUser.id);

if (error) {
console.error('Error updating profile:', error);
return;
}

alert('Profile updated successfully! üéâ');
closeModal('profileModal');
await loadUserProfile(); // Reload profile

} catch (error) {
console.error('Error in profile form submission:', error);
}
});

// Post form submission
document.getElementById('postForm').addEventListener('submit', async function(e) {
e.preventDefault();

try {
const { error } = await supabase
.from('forum_posts')
.insert([
{
user_id: currentUser.id,
title: document.getElementById('postTitle').value,
content: document.getElementById('postContent').value
}
]);

if (error) {
console.error('Error creating post:', error);
return;
}

alert('Post created successfully! üéâ');
closeModal('postModal');
document.getElementById('postForm').reset();
await loadForumPosts(); // Reload forum posts

} catch (error) {
console.error('Error in post form submission:', error);
}
});

// Event form submission (admin only)
document.getElementById('eventForm').addEventListener('submit', async function(e) {
e.preventDefault();

try {
const { error } = await supabase
.from('events')
.insert([
{
title: document.getElementById('eventTitle').value,
description: document.getElementById('eventDescription').value,
event_date: document.getElementById('eventDate').value,
location: document.getElementById('eventLocation').value,
max_attendees: document.getElementById('eventMaxAttendees').value || null,
created_by: currentUser.id
}
]);

if (error) {
console.error('Error creating event:', error);
return;
}

alert('Event created successfully! üéâ');
closeModal('eventModal');
document.getElementById('eventForm').reset();
await loadUpcomingEvents(); // Reload events

} catch (error) {
console.error('Error in event form submission:', error);
}
});

// Announcement form submission (admin only)
document.getElementById('announcementForm').addEventListener('submit', async function(e) {
e.preventDefault();

try {
const title = document.getElementById('announcementTitle').value;
const message = document.getElementById('announcementMessage').value;
const target = document.getElementById('announcementTarget').value;

// Get target users
let targetUsers;
if (target === 'all') {
const { data: users } = await supabase
.from('profiles')
.select('id');
targetUsers = users;
} else {
const { data: users } = await supabase
.from('profiles')
.select('id')
.eq('role', target);
targetUsers = users;
}

// Create notifications for all target users
const notifications = targetUsers.map(user => ({
user_id: user.id,
title: title,
message: message,
type: 'info'
}));

const { error } = await supabase
.from('notifications')
.insert(notifications);

if (error) {
console.error('Error sending announcement:', error);
return;
}

alert(`Announcement sent to ${targetUsers.length} users! üéâ`);
closeModal('announcementModal');
document.getElementById('announcementForm').reset();

} catch (error) {
console.error('Error in announcement form submission:', error);
}
});
});

// Close modals when clicking outside
window.onclick = function(event) {
const modals = document.getElementsByClassName('modal');
for (let modal of modals) {
if (event.target === modal) {
modal.style.display = 'none';
}
}
}
</script>

<!-- jQuery -->
<script src="js/jquery.min.js"></script>
<script src="js/jquery-migrate-3.0.0.js"></script>
<script src="js/jquery-ui.min.js"></script>
<script src="js/easing.js"></script>
<script src="js/colors.js"></script>
<script src="js/popper.min.js"></script>
<script src="js/bootstrap-datepicker.js"></script>
<script src="js/jquery.nav.js"></script>
<script src="js/slicknav.min.js"></script>
<script src="js/jquery.scrollUp.min.js"></script>
<script src="js/niceselect.js"></script>
<script src="js/tilt.jquery.min.js"></script>
<script src="js/owl-carousel.js"></script>
<script src="js/jquery.counterup.min.js"></script>
<script src="js/steller.js"></script>
<script src="js/wow.min.js"></script>
<script src="js/jquery.magnific-popup.min.js"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/waypoints/2.0.3/waypoints.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/main.js"></script>
</body>
</html>
